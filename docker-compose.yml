version: '3.8'

services:
  # MySQL
  mysql:
    image: mysql:8.0
    container_name: elearning-mysql
    restart: unless-stopped
    environment:
      # ğŸ”¸ .envì— MYSQL_ROOT_PASSWORDê°€ ì—†ìœ¼ë©´ ì•„ë˜ì²˜ëŸ¼ í•˜ë‚˜ ì§€ì •í•´ì¤˜ (ì˜ˆ: root ë¹„ë²ˆ)
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${DB_NAME}
      MYSQL_USER: ${DB_USERNAME}
      MYSQL_PASSWORD: ${DB_PASSWORD}
      TZ: Asia/Seoul
    command:
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
      - --max_connections=200
    volumes:
      - /opt/elearning/mysql:/var/lib/mysql
    networks:
      - elearning-network
    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -h 127.0.0.1 -uroot -p\"$MYSQL_ROOT_PASSWORD\" || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Backend (Spring Boot)
  backend:
    build: .
    container_name: elearning-backend
    restart: unless-stopped

    # âœ… ì™¸ë¶€/í”„ë¡ íŠ¸ì—ì„œ ì ‘ê·¼ ê°€ëŠ¥í•˜ê²Œ 8080 ë…¸ì¶œ
    ports:
      - "8080:8080"

    # âœ… ì»¨í…Œì´ë„ˆì— .env ê°’ ì£¼ì…
    env_file:
      - ./.env

    environment:
      # âœ… í”„ë¡œí•„
      SPRING_PROFILES_ACTIVE: prod

      # âœ… DB ì—°ê²° (compose ë‚´ë¶€ MySQLì„ ì‚¬ìš©í•˜ë¯€ë¡œ hostëŠ” 'mysql')
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/${MYSQL_DATABASE}?useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=Asia/Seoul&characterEncoding=UTF-8
      SPRING_DATASOURCE_USERNAME: ${MYSQL_USER}
      SPRING_DATASOURCE_PASSWORD: ${MYSQL_PASSWORD}

      # âœ… CORS/ì—…ë¡œë“œ ê²½ë¡œ ë“± Springì—ì„œ ì°¸ì¡°í•˜ëŠ” ì»¤ìŠ¤í…€ ê°’
      CORS_ALLOWED_ORIGINS: ${CORS_ALLOWED_ORIGINS}
      UPLOAD_DIR: ${UPLOAD_DIR}
      UPLOAD_BASE_URL: ${UPLOAD_BASE_URL}

      # âœ… JWT
      JWT_SECRET: ${JWT_SECRET}

      # âœ… AWS ìê²©ì¦ëª… (S3 ì—…ë¡œë“œ)
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY}

      # âœ… ë©”ì¼(SMTP)
      NAVER_EMAIL_USERNAME: ${NAVER_EMAIL_USERNAME}
      NAVER_EMAIL_PASSWORD: ${NAVER_EMAIL_PASSWORD}

      # âœ… OAuth2 (ë„¤ì´ë²„/ì¹´ì¹´ì˜¤)
      NAVER_CLIENT_ID: ${NAVER_CLIENT_ID}
      NAVER_CLIENT_SECRET: ${NAVER_CLIENT_SECRET}
      KAKAO_CLIENT_ID: ${KAKAO_CLIENT_ID}
      KAKAO_CLIENT_SECRET: ${KAKAO_CLIENT_SECRET}

    depends_on:
      mysql:
        condition: service_healthy
    networks:
      - elearning-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Frontend (Next.js)
  frontend:
    image: ${DOCKER_USERNAME}/elearning-frontend:latest
    container_name: elearning-frontend
    restart: unless-stopped
    ports:
      - "80:3000"
    depends_on:
      - backend
    networks:
      - elearning-network

networks:
  elearning-network:
    driver: bridge
