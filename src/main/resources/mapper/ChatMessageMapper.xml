<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.daepamarket.daepa_market_backend.mapper.ChatMessageMapper">

    <!-- 메시지 조회: 오래된 → 최신 (초기 로드/무한스크롤 상단) -->
    <select id="findMessages"
            resultType="com.daepamarket.daepa_market_backend.common.dto.ChatDto$MessageRes">
        <choose>
            <when test="before == null">
                SELECT * FROM (
                SELECT
                cm_idx       AS messageId,
                ch_idx       AS roomId,
                sender_id    AS senderId,
                message_type AS type,
                cm_content   AS content,
                image_url    AS imageUrl,
                cm_date      AS time
                FROM chat_messages
                WHERE ch_idx = #{roomId}
                ORDER BY cm_idx DESC
                LIMIT #{size}
                ) t
                ORDER BY t.messageId ASC
            </when>
            <otherwise>
                SELECT
                cm_idx       AS messageId,
                ch_idx       AS roomId,
                sender_id    AS senderId,
                message_type AS type,
                cm_content   AS content,
                image_url    AS imageUrl,
                cm_date      AS time
                FROM chat_messages
                WHERE ch_idx = #{roomId}
                AND cm_idx &lt; #{before}
                ORDER BY cm_idx ASC
                LIMIT #{size}
            </otherwise>
        </choose>
    </select>

    <!-- 메시지 1건 -->
    <select id="findOneById"
            resultType="com.daepamarket.daepa_market_backend.common.dto.ChatDto$MessageRes">
        SELECT
            cm_idx       AS messageId,
            ch_idx       AS roomId,
            sender_id    AS senderId,
            message_type AS type,
            cm_content   AS content,
            image_url    AS imageUrl,
            cm_date      AS time
        FROM chat_messages
        WHERE cm_idx = #{id}
            LIMIT 1
    </select>

    <!-- 메시지 저장 (useGeneratedKeys로 cm_idx 회수) -->
    <insert id="insertMessage"
            useGeneratedKeys="true"
            keyProperty="cmIdx"
            keyColumn="cm_idx">
        INSERT INTO chat_messages
        (ch_idx, sender_id, cm_writer, message_type, cm_content, image_url, cm_date)
        VALUES (
        #{chIdx},
        #{senderId},
        #{writer},
        #{messageType},
        #{content},
        #{imageUrl},
        NOW()
        )
    </insert>


    <!-- 읽음 포인터: 방의 최신 메시지까지 -->
    <insert id="upsertRead">
        INSERT INTO chat_reads (ch_idx, cread_reader, last_seen_message_id, updated_at)
        SELECT #{roomId}, #{userId}, COALESCE(MAX(cm_idx), 0), NOW()
        FROM chat_messages
        WHERE ch_idx = #{roomId}
            ON DUPLICATE KEY UPDATE
                                 last_seen_message_id = GREATEST(chat_reads.last_seen_message_id, VALUES(last_seen_message_id)),
                                 updated_at           = NOW()
    </insert>

    <!-- 읽음 포인터: 지정 메시지 id(upTo)까지 끌어올리기 -->
    <insert id="upsertReadUpTo">
        INSERT INTO chat_reads (ch_idx, cread_reader, last_seen_message_id, updated_at)
        VALUES (#{roomId}, #{userId}, COALESCE(#{upTo}, 0), NOW())
            ON DUPLICATE KEY UPDATE
                                 last_seen_message_id = GREATEST(chat_reads.last_seen_message_id, COALESCE(#{upTo}, 0)),
                                 updated_at           = NOW()
    </insert>

    <!-- 안 읽은 메시지 수 -->
    <select id="countUnread" resultType="int">
        SELECT COUNT(*)
        FROM chat_messages m
        WHERE m.ch_idx = #{roomId}
          AND m.cm_idx &gt; COALESCE((
                                         SELECT last_seen_message_id
                                         FROM chat_reads
                                         WHERE ch_idx = #{roomId} AND cread_reader = #{userId}
                                     ), 0)
          AND COALESCE(m.sender_id, -1) != #{userId}
    </select>

    <!-- after(마지막 받은 ID) 초과만 ASC로 반환: 폴링 증분 로딩 -->
    <select id="findMessagesAfter"
            resultType="com.daepamarket.daepa_market_backend.common.dto.ChatDto$MessageRes">
        SELECT
            cm_idx       AS messageId,
            ch_idx       AS roomId,
            sender_id    AS senderId,
            message_type AS type,
            cm_content   AS content,
            image_url    AS imageUrl,
            cm_date      AS time
        FROM chat_messages
        WHERE ch_idx = #{roomId}
          AND cm_idx &gt; #{after}
        ORDER BY cm_idx ASC
            LIMIT #{size}
    </select>

    <!-- ✅ 방의 최신 메시지ID -->
    <select id="selectMaxMessageId" resultType="long">
        SELECT COALESCE(MAX(cm_idx), 0)
        FROM chat_messages
        WHERE ch_idx = #{roomId}
    </select>

    <!-- ✅ 현재 적용된 last_seen_message_id -->
    <select id="selectLastSeen" resultType="long">
        SELECT COALESCE(last_seen_message_id, 0)
        FROM chat_reads
        WHERE ch_idx = #{roomId}
          AND cread_reader = #{userId}
            LIMIT 1
    </select>

</mapper>
