<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.daepamarket.daepa_market_backend.mapper.ChatRoomMapper">

    <select id="listRooms" parameterType="java.lang.Long"
            resultType="com.daepamarket.daepa_market_backend.common.dto.ChatRoomListDto">

        <if test="userId == null">
            SELECT NULL AS roomId WHERE 1 = 0
        </if>

        <if test="userId != null">
            SELECT
            r.ch_idx AS roomId,

            u_other.u_idx AS counterpartyId,
            COALESCE(u_other.u_name, '탈퇴한 사용자') AS counterpartyName,

            COALESCE(p.pd_title, '(삭제된 상품)') AS productTitle,
            COALESCE(p.pd_thumb, '/images/placeholder.jpg') AS productThumb,

            CASE
            WHEN d.seller_idx2 = #{userId} THEN '판매자'
            WHEN d.buyer_idx   = #{userId} THEN '구매자'
            ELSE '참여자' END AS myRole,

            CASE COALESCE(d.d_status, 0)
            WHEN 2 THEN '거래완료'
            WHEN 1 THEN '거래중'
            ELSE '예약중' END AS statusBadge,

            (SELECT m.cm_content FROM chat_messages m
            WHERE m.ch_idx = r.ch_idx
            ORDER BY m.cm_idx DESC LIMIT 1) AS lastMessage,

            (SELECT m.cm_date FROM chat_messages m
            WHERE m.ch_idx = r.ch_idx
            ORDER BY m.cm_idx DESC LIMIT 1) AS lastAt,

            (
            SELECT COUNT(*) FROM chat_messages m
            WHERE m.ch_idx = r.ch_idx
            AND m.cm_idx &gt; COALESCE((
            SELECT cr_inner.last_seen_message_id
            FROM chat_reads cr_inner
            WHERE cr_inner.ch_idx = r.ch_idx AND cr_inner.cread_reader = #{userId}
            ), 0)
            AND COALESCE(m.sender_id, -1) != #{userId}
            ) AS unread

            FROM chat_reads cr

            JOIN chat_rooms r ON r.ch_idx = cr.ch_idx

            LEFT JOIN chat_reads cr_other ON cr_other.ch_idx = r.ch_idx AND cr_other.cread_reader != #{userId}
            LEFT JOIN `user` u_other ON u_other.u_idx = cr_other.cread_reader

            LEFT JOIN deal    d ON d.d_idx  = r.d_idx
            LEFT JOIN product p ON p.pd_idx = r.pd_idx

            WHERE cr.cread_reader = #{userId}

            ORDER BY r.ch_updated DESC, r.ch_idx DESC
        </if>
    </select>

    <update id="touchUpdated">
        UPDATE chat_rooms SET ch_updated = NOW(6) WHERE ch_idx = #{roomId}
    </update>

    <select id="findRoomIdByIdentifier" resultType="long">
        SELECT ch_idx FROM chat_rooms
        WHERE ch_identifier = #{identifier}
            LIMIT 1
    </select>

    <insert id="insertRoomIfAbsent">
        INSERT INTO chat_rooms (pd_idx, ch_created, ch_updated, ch_identifier)
        VALUES (#{pdId}, NOW(6), NOW(6), #{identifier})
            ON DUPLICATE KEY UPDATE ch_updated = VALUES(ch_updated)
    </insert>

    <insert id="upsertRead">
        INSERT INTO chat_reads (ch_idx, cread_reader, last_seen_message_id, updated_at)
        SELECT #{roomId}, #{userId},
               COALESCE((SELECT MAX(cm_idx) FROM chat_messages WHERE ch_idx = #{roomId}), 0),
               NOW()
            ON DUPLICATE KEY UPDATE
                                 last_seen_message_id = GREATEST(
                                 chat_reads.last_seen_message_id,
                                 COALESCE((SELECT MAX(cm_idx) FROM chat_messages WHERE ch_idx = #{roomId}), 0)
                                 ),
                                 updated_at = NOW()
    </insert>

    <select id="isNewlyCreated" resultType="int">
        SELECT CASE WHEN TIMESTAMPDIFF(SECOND, ch_created, NOW(6)) &lt;= 60 THEN 1 ELSE 0 END
        FROM chat_rooms
        WHERE ch_idx = #{roomId}
            LIMIT 1
    </select>

    <insert id="insertSystemMessage">
        INSERT INTO chat_messages
        (ch_idx, sender_id, cm_writer, message_type, cm_content, image_url, cm_date)
        VALUES
            (#{chIdx}, NULL, 'SYSTEM', 'SYSTEM', #{content}, NULL, NOW())
    </insert>

</mapper>