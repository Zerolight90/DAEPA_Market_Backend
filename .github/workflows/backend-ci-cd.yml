#name: Backend CI/CD
#
#on:
#  push:
#    branches: [ "1031JongMin" ] # main 브랜치에 푸시될 때 실행
#
#jobs:
#  # --- 1. 빌드 및 Docker Hub 푸시 작업 ---
#  build-and-push:
#    name: Build and Push to Docker Hub
#    runs-on: ubuntu-latest
#
#    steps:
#      # 1. 소스코드 체크아웃
#      - name: Checkout code
#        uses: actions/checkout@v3
#
#      # 2. Docker Hub 로그인
#      - name: Login to Docker Hub
#        uses: docker/login-action@v2
#        with:
#          username: ${{ secrets.DOCKER_USERNAME }} # GitHub Secret 필요
#          password: ${{ secrets.DOCKER_PASSWORD }} # GitHub Secret 필요
#
#      # 3. Docker Buildx 설정 (권장)
#      - name: Set up Docker Buildx
#        uses: docker/setup-buildx-action@v2
#
#      # 4. 백엔드 Docker 이미지 빌드 및 푸시
#      - name: Build and push Backend
#        uses: docker/build-push-action@v4
#        with:
#          context: . # Dockerfile 위치 (레포지토리 루트)
#          file: ./Dockerfile
#          push: true # Docker Hub에 푸시
#          tags: ${{ secrets.DOCKER_USERNAME }}/daepa-backend:latest # {Docker ID}/[이미지 이름]:[태그]
#
#  # --- 2. 배포 작업 (EC2 서버) ---
#  deploy:
#    name: Deploy to EC2 Server
#    needs: build-and-push # build-and-push 작업이 성공해야 실행
#    runs-on: ubuntu-latest
#
#    steps:
#      # 1. SSH로 서버에 접속하여 배포 스크립트 실행
#      - name: Deploy via SSH
#        uses: appleboy/ssh-action@master
#        with:
#          host: ${{ secrets.SERVER_IP }} # 서버 IP (GitHub Secret 필요)
#          username: ${{ secrets.SERVER_USER }} # 서버 접속 유저 (GitHub Secret 필요)
#          key: ${{ secrets.SERVER_SSH_KEY }} # 서버 접속용 SSH 개인키 (GitHub Secret 필요)
#
#          script: |
#            # 배포 디렉토리 생성 (없으면)
#            mkdir -p ~/app/daepa-backend
#            cd ~/app/daepa-backend
#
#            # docker-compose.yml 파일 생성 (GitHub Secret에서 읽어옴)
#            echo "${{ secrets.DOCKER_COMPOSE_YML }}" > docker-compose.yml
#
#            # .env 파일 생성 (GitHub Secret에서 읽어옴 - DB, JWT 정보)
#            echo "${{ secrets.ENV_FILE }}" > .env
#
#            # Docker Hub 로그인 (서버에서도 필요할 수 있음)
#            docker login -u ${{ secrets.DOCKER_USERNAME }} -p ${{ secrets.DOCKER_PASSWORD }}
#
#            # Docker Hub에서 최신 백엔드 이미지 받기
#            docker pull ${{ secrets.DOCKER_USERNAME }}/daepa-backend:latest
#
#            # Docker Compose로 서비스 재시작
#            docker-compose up -d --force-recreate
#
#            # (선택) 불필요한 옛날 이미지 정리
#            docker image prune -f